#!/bin/bash

set -e -u

source $(dirname $0)/common.sh

if ! git remote | grep upstream >/dev/null; then
  git remote add upstream https://github.com/dexidp/dex
fi

progress "fetching origin to sync pr branches"
git fetch origin
git remote update origin --prune

progress "fetching upstream master"
git fetch upstream master

progress "merging all PRs on fresh upstream"
git checkout $merged_branch
git reset --hard upstream/master
git branch -a | grep remotes/origin/pr | sed -e 's|\s*remotes/||' | xargs git merge

./post-merge
